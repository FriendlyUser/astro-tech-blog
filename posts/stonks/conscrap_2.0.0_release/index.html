<!DOCTYPE html><html lang="en"> <head><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Conscrap 2.0.0 Release - FriendlyUsers Tech Blog</title><meta name="description" content="Explaining how I fixed conscrap using the new shadow root api"><meta name="author" content="David Li"><link rel="alternate" type="application/rss+xml" href="/rss.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2479144310234386" crossorigin="anonymous"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-119155027-6"></script><script type="text/javascript">
      let slideIndex = 1;
      showSlides(slideIndex);

      function plusSlides(n) {
        showSlides((slideIndex += n));
      }

      function currentSlide(n) {
        showSlides((slideIndex = n));
      }

      function showSlides(n) {
        try {
          let i;
          let slides = document.getElementsByClassName('mySlides');
          let dots = document.getElementsByClassName('demo');
          let captionText = document.getElementById('caption');
          if (n > slides.length) {
            slideIndex = 1;
          }
          if (n < 1) {
            slideIndex = slides.length;
          }
          for (i = 0; i < slides.length; i++) {
            slides[i].style.display = 'none';
          }
          for (i = 0; i < dots.length; i++) {
            dots[i].className = dots[i].className.replace(' active', '');
          }
          slides[slideIndex - 1].style.display = 'block';
          dots[slideIndex - 1].className += ' active';
          captionText.innerHTML = dots[slideIndex - 1].alt;
        } catch (err) {
          // do nothing here
        }
      }
    </script><!-- Google Tag Manager --><!-- End Google Tag Manager --><link rel="stylesheet" href="/_astro/index.DFWZl3Z8.css" />
<style>.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);-webkit-clip-path:inset(50%);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}@media print{.no-print,.no-print *{display:none!important}}
</style><script type="module" src="/_astro/hoisted.CcuKkQrI.js"></script></head> <body class="bg-slate-900 text-gray-100"> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K8P5P8FQ" height="0" width="0" style="display:none;visibility:hidden"></iframe> </noscript> <!-- End Google Tag Manager (noscript) --> <div class="mx-auto max-w-screen-lg px-3 py-6"><div class="flex flex-col gap-y-3 sm:flex-row sm:items-center sm:justify-between"><a href="/"><div class="flex items-center bg-gradient-to-br from-sky-500 to-cyan-400 bg-clip-text text-xl font-bold text-transparent"><svg class="mr-1 h-10 w-10 stroke-cyan-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M0 0h24v24H0z" stroke="none"></path><rect x="3" y="12" width="6" height="8" rx="1"></rect><rect x="9" y="8" width="6" height="12" rx="1"></rect><rect x="15" y="4" width="6" height="16" rx="1"></rect><path d="M4 20h14"></path></svg>David&#x27;s Blog</div></a><nav><ul class="flex gap-x-3 font-medium text-gray-200"><li class="hover:text-white"><a href="/posts">Blogs</a></li><li class="hover:text-white"><a href="https://github.com/FriendlyUser/astro-tech-blog">GitHub</a></li><li class="hover:text-white"><a href="/photos">Photos</a></li></ul></nav></div></div> <div data-pagefind-body>  <div class="mx-auto max-w-screen-lg px-3 py-6"><div><h1 class="text-center text-3xl font-bold">Conscrap 2.0.0 Release</h1><div class="mt-2 text-center text-sm text-gray-400">By <!-- -->David Li<!-- --> on <!-- -->Friday, 25 August 2023 13:00:00 GMT</div><div class="flex place-content-center pt-2"><div class="rounded-md px-2 py-1 text-xs font-semibold bg-cyan-400 text-cyan-900"> <a href="/tags/dotnet" style="padding-right:3px"> <category>dotnet<!-- --> </category></a></div> <div class="rounded-md px-2 py-1 text-xs font-semibold bg-cyan-400 text-cyan-900"> <a href="/tags/stonks" style="padding-right:3px"> <category>stonks<!-- --> </category></a></div> <div class="rounded-md px-2 py-1 text-xs font-semibold bg-cyan-400 text-cyan-900"> <a href="/tags/selenium" style="padding-right:3px"> <category>selenium<!-- --> </category></a></div> </div><div class="mx-auto mt-5 max-w-prose"><div class="aspect-w-3 aspect-h-2"><img class="h-full w-full rounded-lg object-cover object-center" src="/imgs/2023/conscrap200.png" alt="Conscrap" loading="lazy"/></div><div class="prose prose-invert mt-8 prose-img:rounded-lg"><content> <h2 id="shadow-root">Shadow Root</h2>
<p>The ShadowRoot interface represents the root of a shadow DOM subtree, which is a separate DOM tree that is hidden from the main document tree. The Element.shadowRoot property allows you to access the shadow root of an element, but only if it was created using the Element.attachShadow() method with the mode set to “open”.</p>
<p>Web scraping shadow roots with Selenium can be a bit more challenging than scraping regular web pages because shadow roots are not directly accessible from the main DOM tree. However, it is still possible to scrape data from shadow roots using Selenium by utilizing its JavaScript execution capabilities.</p>
<p>Here’s an example of how you might do this in Python:</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> selenium </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> webdriver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F"># create a new instance of the Firefox driver</span></span>
<span class="line"><span style="color:#F8F8F2">driver </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> webdriver.Firefox()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F"># navigate to the page you want to scrape</span></span>
<span class="line"><span style="color:#F8F8F2">driver.get(</span><span style="color:#E6DB74">"https://example.com"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F"># execute a JavaScript script to get the shadow root</span></span>
<span class="line"><span style="color:#F8F8F2">shadow_root </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> driver.execute_script(</span><span style="color:#E6DB74">"return arguments[0].shadowRoot"</span><span style="color:#F8F8F2">, element)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F"># now you can access the shadow root like a regular DOM tree</span></span>
<span class="line"><span style="color:#88846F"># and scrape the data you need</span></span>
<span class="line"><span style="color:#F8F8F2">data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> shadow_root.find_element_by_css_selector(</span><span style="color:#E6DB74">"#data"</span><span style="color:#F8F8F2">).text</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F"># close the browser</span></span>
<span class="line"><span style="color:#F8F8F2">driver.quit()</span></span></code></pre>
<p>Here, element is the element whose shadow root you want to access.</p>
<p>It’s worth noting that if the website you want to scrape is using Shadow DOM v0, you can directly access the shadow root of an element using the element.shadowRoot property. But for Shadow DOM v1 or later, you need to use the above script.</p>
<p>Also, keep in mind that some website might have anti-scraping measures or CORS policy that might block Selenium scraping and in that case, you might have to use a proxy or a VPN to bypass it.</p>
<p>With the changes to the yahoo finance comments api, the comments are added to the dom via a shadow root. In order to scrap the comments from yahoo finance, I have to access the shadow root.</p>
<p>Instead of leverage selenium bindings in C#, I decided to use plain javascript to access all shadowroots and return the comments as a html string.</p>
<p>The js command I send over to selenium, creates a function to get all shadow roots and then finds a certain selector.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#A6E22E;text-decoration:underline">String</span><span style="color:#F8F8F2"> getCommentsCmd </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> Constants.jsQuerySelectorAllShadows </span><span style="color:#F92672">+</span><span style="color:#E6DB74"> """const results = querySelectorAllShadows("ul.spcv_messages-list"); return results[0].outerHTML.toString();"""</span><span style="color:#F8F8F2">;</span></span></code></pre>
<p>That selector has dom elements that contain all the comments for the yahoo finance stock.</p>
<p>The function takes two arguments:</p>
<ul>
<li>selector: a string containing a CSS selector that specifies the elements to search for.</li>
<li>el: (optional) The DOM element to start searching from, defaults to document.body if not provided. The function first searches for all elements with shadowRoot property and recursively calls itself on each of these shadow roots.</li>
</ul>
<p>It then takes the results of these recursive calls and concatenates them with the results obtained from the current el.querySelectorAll(selector) call.
Finally, it flattens the results array and returns it.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F92672">        public</span><span style="color:#F92672"> const</span><span style="color:#F92672"> string</span><span style="color:#F8F8F2"> jsQuerySelectorAllShadows </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> </span></span>
<span class="line"><span style="color:#E6DB74">@"function querySelectorAllShadows(selector, el = document.body) {</span></span>
<span class="line"><span style="color:#E6DB74">                // recurse on childShadows</span></span>
<span class="line"><span style="color:#E6DB74">                const childShadows = Array.from(el.querySelectorAll('*')).</span></span>
<span class="line"><span style="color:#E6DB74">                    map(el => el.shadowRoot).filter(Boolean);</span></span>
<span class="line"><span style="color:#E6DB74">                // console.log('[querySelectorAllShadows]', selector, el, `(${childShadows.length} shadowRoots)`);</span></span>
<span class="line"><span style="color:#E6DB74">                const childResults = childShadows.map(child => querySelectorAllShadows(selector, child));</span></span>
<span class="line"><span style="color:#E6DB74">                </span></span>
<span class="line"><span style="color:#E6DB74">                // fuse all results into singular, flat array</span></span>
<span class="line"><span style="color:#E6DB74">                const result = Array.from(el.querySelectorAll(selector));</span></span>
<span class="line"><span style="color:#E6DB74">                return result.concat(childResults).flat();</span></span>
<span class="line"><span style="color:#E6DB74">            }</span></span>
<span class="line"><span style="color:#E6DB74">"</span><span style="color:#F8F8F2">;</span></span></code></pre>
<p>The disadvantage of selenium based web-scrapping tends to be the speed.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F92672">try</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#88846F">    // find Maybe later by text Maybe Later</span></span>
<span class="line"><span>    </span><span style="color:#A6E22E;text-decoration:underline">IWebElement</span><span style="color:#F8F8F2"> maybeLater </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> driver.</span><span style="color:#A6E22E">FindElement</span><span style="color:#F8F8F2">(By.</span><span style="color:#A6E22E">XPath</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"//button[contains(text(), 'Maybe later')]"</span><span style="color:#F8F8F2">));</span></span>
<span class="line"><span style="color:#88846F">    // IWebElement maybeLater = driver.FindElement(By.XPath("//button[contains(@class, 'btn btn-primary')]"));</span></span>
<span class="line"><span style="color:#F8F8F2">    maybeLater.</span><span style="color:#A6E22E">Click</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">} </span><span style="color:#F92672">catch</span><span style="color:#F8F8F2"> (</span><span style="color:#A6E22E;text-decoration:underline">NoSuchElementException</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    Console.</span><span style="color:#A6E22E">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"No Maybe Later Button"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>After swapping to the iframe containing all the comments, I attempt to hide the Maybe later popout that yahoo finance shows for unauthenticated users.</p>
<p>Outside of that, there are some minor xpath adjustments that were made due to changes in the comment format.</p>
<h2 id="migrating-to-net-70">Migrating to .NET 7.0</h2>
<p>In general it was pretty simple for this project to migrate to .net 7.0, have not encountered any major issues.</p>
<p>Migrating from .NET 6.0 to .NET 7.0 will depend on the specific applications and libraries that you are using. Here are a few general steps that you can follow:</p>
<p>Check for compatibility: Before you begin, check if your application and its dependencies are compatible with .NET 7.0. Some libraries or frameworks may not have been updated to work with the latest version of .NET, and you may need to find alternatives or wait for updates.</p>
<p>Update the target framework: Update your application’s target framework to .NET 7.0. You can do this by opening your project in Visual Studio and navigating to the Properties page.</p>
<h2 id="publishing-to-nuget">Publishing to nuget</h2>
<p>In this release, I added a deployment action to nuget for github and nuget packages.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F92672">if</span><span style="color:#F8F8F2">: </span><span style="color:#E6DB74">startsWith(github.ref, 'refs/heads/release')</span></span>
<span class="line"><span style="color:#F92672">run</span><span style="color:#F8F8F2">: </span><span style="color:#F92672">|</span></span>
<span class="line"><span style="color:#E6DB74">  dotnet pack --configuration $BUILD_CONFIG --no-restore</span></span>
<span class="line"><span style="color:#E6DB74">  nuget setapikey "${{ secrets.NUGET_KEY }}"</span></span>
<span class="line"><span style="color:#E6DB74">  nuget push **\*.nupkg -Source "https://api.nuget.org/v3/index.json" -SkipDuplicate</span></span>
<span class="line"><span style="color:#E6DB74">  dotnet nuget add source --username dli-invest --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/dli-invest/index.json"</span></span>
<span class="line"><span style="color:#E6DB74">  dotnet nuget push **\*.nupkg --api-key "${{ secrets.GITHUB_TOKEN }}" --source "github"</span></span></code></pre>
<h2 id="references">References</h2>
<p>View the documentation for conscrap at</p>
<ul>
<li><a href="https://github.com/dli-invest/conscrap">https://github.com/dli-invest/conscrap</a></li>
</ul> <h5>Related Projects</h5> <a href="https://github.com/dli-invest/conscrap" style="text-decoration:none;width:200px;text-align:center"> <h3> <div class="rounded-md px-2 py-1 text-xs font-semibold bg-green-400 text-green-900">conscrap</div> </h3> </a> </content></div></div></div></div> <div class="mx-auto max-w-screen-lg px-3 py-6"> <div class="no-print flex w-full"> <form class="max-w-lg" action="https://formspree.io/f/davidli012345@gmail.com" method="POST"><div class="-mx-3 mb-6 flex flex-wrap"><div class="mb-6 w-full px-3 md:mb-0 md:w-1/2"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-first-name">First Name</label><input class="mb-3 block w-full appearance-none rounded py-3 px-4 leading-tight text-gray-700 focus:bg-white focus:outline-none" id="grid-first-name" type="text" placeholder="Jane"/></div><div class="w-full px-3 md:w-1/2"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-last-name">Last Name</label><input class="block w-full appearance-none rounded border border-gray-200  py-3 px-4 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none" id="grid-last-name" type="text" placeholder="Doe"/></div></div><div class="-mx-3 mb-6 flex flex-wrap"><div class="w-full px-3"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-password">E-mail</label><input class="mb-3 block w-full appearance-none rounded border py-3 px-4 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none" id="email" type="email"/></div></div><div class="-mx-3 mb-6 flex flex-wrap"><div class="w-full px-3"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-password">Message</label><textarea class="no-resize mb-3 block h-48 w-full resize-none appearance-none rounded border border-gray-200 py-3 px-4 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none" id="message"></textarea></div></div><div class="md:flex md:items-center"><div class="md:w-1/3"><button class="ml-2 shrink-0 rounded-full bg-gradient-to-br from-sky-500 to-cyan-400 px-3 py-1 text-sm font-medium text-gray-700 hover:from-sky-700 hover:to-cyan-600 focus:outline-none focus:ring-2 focus:ring-cyan-600/50" type="submit">Send</button></div><div class="md:w-2/3"></div></div></form> <div class="ml-3 max-w-lg bg-slate-300"> <link href="/_pagefind/pagefind-ui.css" rel="stylesheet"> <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script> <div id="search" class="ml-3 p-4"></div>  </div> </div> </div>  </div> <div class="mx-auto max-w-screen-lg px-3 py-6"><div class="no-print border-t border-gray-600 pt-5"><div class="text-sm text-gray-200">© Copyright <!-- -->2024<!-- --> by <!-- -->FriendlyUsers Tech Blog<!-- -->. Built with ♥ by<!-- --> <a class="text-cyan-400 hover:underline" href="https://github.com/FriendlyUser" target="_blank" rel="noopener noreferrer">FriendlyUser</a>. Last updated on <!-- -->2024-11-04<!-- -->.</div></div><script src="https://cdn.botpress.cloud/webchat/v0/inject.js"></script><script src="https://mediafiles.botpress.cloud/0df54034-3318-451a-aed0-3923a4ee25a5/webchat/config.js" defer=""></script></div> </body></html>