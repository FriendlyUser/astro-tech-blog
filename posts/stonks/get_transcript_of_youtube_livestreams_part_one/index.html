<!DOCTYPE html><html lang="en"> <head><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Get Transcript of youtube livestreams Part I - FriendlyUsers Tech Blog</title><meta name="description" content="Transcript of youtube livestreams main overview using whispers"><meta name="author" content="David Li"><link rel="alternate" type="application/rss+xml" href="/rss.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2479144310234386" crossorigin="anonymous"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-119155027-6"></script><script type="text/javascript">
      let slideIndex = 1;
      showSlides(slideIndex);

      function plusSlides(n) {
        showSlides((slideIndex += n));
      }

      function currentSlide(n) {
        showSlides((slideIndex = n));
      }

      function showSlides(n) {
        try {
          let i;
          let slides = document.getElementsByClassName('mySlides');
          let dots = document.getElementsByClassName('demo');
          let captionText = document.getElementById('caption');
          if (n > slides.length) {
            slideIndex = 1;
          }
          if (n < 1) {
            slideIndex = slides.length;
          }
          for (i = 0; i < slides.length; i++) {
            slides[i].style.display = 'none';
          }
          for (i = 0; i < dots.length; i++) {
            dots[i].className = dots[i].className.replace(' active', '');
          }
          slides[slideIndex - 1].style.display = 'block';
          dots[slideIndex - 1].className += ' active';
          captionText.innerHTML = dots[slideIndex - 1].alt;
        } catch (err) {
          // do nothing here
        }
      }
    </script><!-- Google Tag Manager --><!-- End Google Tag Manager --><link rel="stylesheet" href="/_astro/index.DFWZl3Z8.css" />
<style>.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);-webkit-clip-path:inset(50%);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}@media print{.no-print,.no-print *{display:none!important}}
</style><script type="module" src="/_astro/hoisted.CcuKkQrI.js"></script></head> <body class="bg-slate-900 text-gray-100"> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K8P5P8FQ" height="0" width="0" style="display:none;visibility:hidden"></iframe> </noscript> <!-- End Google Tag Manager (noscript) --> <div class="mx-auto max-w-screen-lg px-3 py-6"><div class="flex flex-col gap-y-3 sm:flex-row sm:items-center sm:justify-between"><a href="/"><div class="flex items-center bg-gradient-to-br from-sky-500 to-cyan-400 bg-clip-text text-xl font-bold text-transparent"><svg class="mr-1 h-10 w-10 stroke-cyan-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M0 0h24v24H0z" stroke="none"></path><rect x="3" y="12" width="6" height="8" rx="1"></rect><rect x="9" y="8" width="6" height="12" rx="1"></rect><rect x="15" y="4" width="6" height="16" rx="1"></rect><path d="M4 20h14"></path></svg>David&#x27;s Blog</div></a><nav><ul class="flex gap-x-3 font-medium text-gray-200"><li class="hover:text-white"><a href="/posts">Blogs</a></li><li class="hover:text-white"><a href="https://github.com/FriendlyUser/astro-tech-blog">GitHub</a></li><li class="hover:text-white"><a href="/photos">Photos</a></li></ul></nav></div></div> <div data-pagefind-body>  <div class="mx-auto max-w-screen-lg px-3 py-6"><div><h1 class="text-center text-3xl font-bold">Get Transcript of youtube livestreams Part I</h1><div class="mt-2 text-center text-sm text-gray-400">By <!-- -->David Li<!-- --> on <!-- -->Friday, 13 March 2023 13:00:00 GMT</div><div class="flex place-content-center pt-2"><div class="rounded-md px-2 py-1 text-xs font-semibold bg-cyan-400 text-cyan-900"> <a href="/tags/youtube" style="padding-right:3px"> <category>youtube<!-- --> </category></a></div> <div class="rounded-md px-2 py-1 text-xs font-semibold bg-cyan-400 text-cyan-900"> <a href="/tags/whispers" style="padding-right:3px"> <category>whispers<!-- --> </category></a></div> <div class="rounded-md px-2 py-1 text-xs font-semibold bg-green-400 text-green-900"> <a href="/tags/python" style="padding-right:3px"> <category>python<!-- --> </category></a></div> </div><div class="mx-auto mt-5 max-w-prose"><div class="aspect-w-3 aspect-h-2"><img class="h-full w-full rounded-lg object-cover object-center" src="/imgs/2022/dall-e/DALL·E 2022-12-15 20.40.00 - blank transcript.png" alt="rbc stock analyzer" loading="lazy"/></div><div class="prose prose-invert mt-8 prose-img:rounded-lg"><content> <p>YouTube live stream is a video that is broadcast in real-time over the internet. Users can watch the video as it is being recorded, and they can also interact with the person who is streaming the video by leaving comments and questions.</p>
<p>Below is a simple script to transcribe a video from a url</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> os</span></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> requests</span></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> json</span></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> argparse</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> utils </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> send_discord_msg</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> processing </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> transcribe_audio_whisper</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">def</span><span style="color:#A6E22E"> download_file_from_url</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">url</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">filename</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#88846F">    # open in binary mode</span></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> os.path.exists(filename):</span></span>
<span class="line"><span style="color:#F8F8F2">        os.remove(filename)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF">    print</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"downloading video"</span><span style="color:#F8F8F2">, url)</span></span>
<span class="line"><span style="color:#F92672">    with</span><span style="color:#66D9EF"> open</span><span style="color:#F8F8F2">(filename, </span><span style="color:#E6DB74">"wb"</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">as</span><span style="color:#F8F8F2"> file:</span></span>
<span class="line"><span style="color:#88846F">        # get request</span></span>
<span class="line"><span style="color:#F8F8F2">        response </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> requests.get(url)</span></span>
<span class="line"><span style="color:#88846F">        # write to file</span></span>
<span class="line"><span style="color:#F8F8F2">        file.write(response.content)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">def</span><span style="color:#A6E22E"> transcribe_video</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">url</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">str</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#88846F">    # check if url is a local path or a url</span></span>
<span class="line"><span style="color:#F8F8F2">    filename </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> url</span></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> url.startswith(</span><span style="color:#E6DB74">"http"</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#88846F">        # get video id</span></span>
<span class="line"><span style="color:#F8F8F2">        download_file_from_url(url, </span><span style="color:#E6DB74">"video.mp4"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        filename </span><span style="color:#F92672">=</span><span style="color:#E6DB74"> "video.mp4"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> transcribe_audio_whisper(filename, </span><span style="color:#AE81FF">False</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    partial_output </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> filename.replace(</span><span style="color:#E6DB74">".mp4"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">".json"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">    with</span><span style="color:#66D9EF"> open</span><span style="color:#F8F8F2">(partial_output, </span><span style="color:#E6DB74">"w"</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">encoding</span><span style="color:#F92672">=</span><span style="color:#E6DB74">"utf-8"</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">errors</span><span style="color:#F92672">=</span><span style="color:#E6DB74">"ignore"</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">as</span><span style="color:#F8F8F2"> f:</span></span>
<span class="line"><span style="color:#F8F8F2">        f.write(json.dumps(data, </span><span style="color:#FD971F;font-style:italic">indent</span><span style="color:#F92672">=</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    ds_data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#E6DB74">        "content"</span><span style="color:#F8F8F2">: data.get(</span><span style="color:#E6DB74">"text"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#AE81FF">    CHUNK_SIZE</span><span style="color:#F92672"> =</span><span style="color:#AE81FF"> 1900</span></span>
<span class="line"><span style="color:#F8F8F2">    chunks </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [ds_data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">][i:i</span><span style="color:#F92672">+</span><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">for</span><span style="color:#F8F8F2"> i </span><span style="color:#F92672">in</span><span style="color:#66D9EF"> range</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">, </span><span style="color:#66D9EF">len</span><span style="color:#F8F8F2">(ds_data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">]), </span><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F8F8F2">)]</span></span>
<span class="line"><span style="color:#F92672">    for</span><span style="color:#F8F8F2"> chunk </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> chunks:</span></span>
<span class="line"><span style="color:#F92672">        try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            send_discord_msg({</span></span>
<span class="line"><span style="color:#E6DB74">                "content"</span><span style="color:#F8F8F2">: chunk,</span></span>
<span class="line"><span style="color:#F8F8F2">            })</span></span>
<span class="line"><span style="color:#F92672">        except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> e:</span></span>
<span class="line"><span style="color:#F92672">            return</span></span>
<span class="line"><span style="color:#F92672">    pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">if</span><span style="color:#F8F8F2"> __name__ </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> "__main__"</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">    parser </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> argparse.ArgumentParser(</span><span style="color:#FD971F;font-style:italic">description</span><span style="color:#F92672">=</span><span style="color:#E6DB74">'Process video from url'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    parser.add_argument(</span><span style="color:#E6DB74">"--url"</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">help</span><span style="color:#F92672">=</span><span style="color:#E6DB74">"url where you can download video"</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">default</span><span style="color:#F92672">=</span><span style="color:#E6DB74">"https://www.dropbox.com/s/jvajeen28clpicy/archive.mp4?dl=1"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    args </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> parser.parse_args()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F">    # todo add logging</span></span>
<span class="line"><span style="color:#F8F8F2">    transcribe_video(args.url)</span></span></code></pre>
<p>This is a script that allows you to transcribe the audio from a video. It does this by first downloading the video from the specified URL (if the URL is a link) or using a local file (if the URL is a file path). Then, it transcribes the audio from the video using the transcribe_audio_whisper function. The transcription is stored in a JSON file and is also sent in chunks to a Discord channel using the send_discord_msg function.</p>
<p>The script takes one argument, —url, which specifies the URL or file path of the video to be transcribed. If no value is provided for —url, the default value is set to a specific Dropbox link.</p>
<p>To use the script, you will need to have the necessary dependencies installed, including the requests and argparse libraries. You will also need to define the transcribe_audio_whisper and send_discord_msg functions in the appropriate files.</p>
<p>Discord can only handle messages up to 2000 characters, so we need to split the message into chunks of 1900 characters. We can do this by using the following code:</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F92672"> =</span><span style="color:#AE81FF"> 1900</span></span>
<span class="line"><span style="color:#F8F8F2">chunks </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [ds_data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">][i:i</span><span style="color:#F92672">+</span><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">for</span><span style="color:#F8F8F2"> i </span><span style="color:#F92672">in</span><span style="color:#66D9EF"> range</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">, </span><span style="color:#66D9EF">len</span><span style="color:#F8F8F2">(ds_data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">]), </span><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F8F8F2">)]</span></span>
<span class="line"><span style="color:#F92672">for</span><span style="color:#F8F8F2"> chunk </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> chunks:</span></span>
<span class="line"><span style="color:#F92672">    try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">        send_discord_msg({</span></span>
<span class="line"><span style="color:#E6DB74">            "content"</span><span style="color:#F8F8F2">: chunk,</span></span>
<span class="line"><span style="color:#F8F8F2">        })</span></span>
<span class="line"><span style="color:#F92672">    except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> e:</span></span>
<span class="line"><span style="color:#F92672">        return</span></span></code></pre>
<p>This code is responsible for sending the transcribed audio from the video to a Discord channel. The CHUNK_SIZE variable is set to 1900, which determines the size of each chunk of text that will be sent to Discord.</p>
<p>The chunks variable is a list comprehension that splits the transcription into chunks of size CHUNK_SIZE. It does this by iterating through the transcription text, starting at index 0 and ending at the length of the text, with a step size of CHUNK_SIZE. This creates a list of strings, each of which is a chunk of the transcription text.</p>
<p>The for loop iterates over each chunk in the chunks list and sends it to the Discord channel using the send_discord_msg function. If an exception occurs while sending the message, the loop is exited by returning from the function.</p>
<p>For the fdrtt class, originally the implementation was using facebook’s wit ai, but I switched it over to whispers from open ai and got vastly improved performance.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> os</span></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> argparse</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> threading </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> Thread</span></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> time</span></span>
<span class="line"><span style="color:#F92672">import</span><span style="color:#F8F8F2"> json</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> operator </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> itemgetter</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> processing </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> get_video_from_start, transcribe_audio_wit, transcribe_audio_whisper</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> utils </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> get_video_id_from_ytube_url, ic, send_discord_msg, format_time, append_to_github_actions</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> yt_utils </span><span style="color:#F92672">import</span><span style="color:#F8F8F2"> get_video_metadata, youtube_livestream_codes, youtube_mp4_codes</span></span>
<span class="line"><span style="color:#F92672">from</span><span style="color:#F8F8F2"> database </span><span style="color:#F92672">import</span><span style="color:#AE81FF"> DB_MANAGER</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#AE81FF">    MAX_ITERATIONS</span><span style="color:#F92672"> =</span><span style="color:#F8F8F2"> os.getenv(</span><span style="color:#E6DB74">"MAX_ITERATIONS"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">"50"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#AE81FF">    MAX_ITERATIONS</span><span style="color:#F92672"> =</span><span style="color:#66D9EF;font-style:italic"> int</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">MAX_ITERATIONS</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> e:</span></span>
<span class="line"><span style="color:#66D9EF">    print</span><span style="color:#F8F8F2">(e)</span></span>
<span class="line"><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F92672"> =</span><span style="color:#AE81FF"> 1900</span></span>
<span class="line"><span style="color:#AE81FF">VIDEO_CHUNK_LENGTH_IN_SECS</span><span style="color:#F92672"> =</span><span style="color:#AE81FF"> 4</span><span style="color:#F92672"> *</span><span style="color:#AE81FF"> 60</span><span style="color:#F92672"> +</span><span style="color:#AE81FF"> 30</span></span></code></pre>
<p>This code appears to be part of a class that processes a video and performs transcription on it. The transcribe method takes a dictionary of data as an argument and uses it to transcribe the audio from the video. It does this by calling either the transcribe_audio_whisper or transcribe_audio_wit function, depending on the value of the transcribe_tool attribute.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#66D9EF;font-style:italic">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline">FD_RTT</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    def</span><span style="color:#66D9EF"> __init__</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">input_args</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">config</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">._config </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> config</span></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.video_url </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> input_args.get(</span><span style="color:#E6DB74">"url"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">        # times in seconds, iterations should not be greater than max time</span></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.stats </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#E6DB74">            "run_time"</span><span style="color:#F8F8F2">: </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">            "start_time"</span><span style="color:#F8F8F2">: time.time(),</span></span>
<span class="line"><span style="color:#E6DB74">            "iterations"</span><span style="color:#F8F8F2">: </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">            "transcriptions"</span><span style="color:#F8F8F2">: [],</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.exit_on_video </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> input_args.get(</span><span style="color:#E6DB74">"exit_on_video"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">True</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.metadata </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> get_video_metadata(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.video_url)</span></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.curr_errors </span><span style="color:#F92672">=</span><span style="color:#AE81FF"> 0</span></span>
<span class="line"><span style="color:#F8F8F2">        table_name </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> os.getenv(</span><span style="color:#E6DB74">"TABLE_NAME"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> table_name </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> None</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            table_name </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> input_args.get(</span><span style="color:#E6DB74">"table_name"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> table_name </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> None</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            table_name </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.get_channel_from_name().replace(</span><span style="color:#E6DB74">" "</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">"_"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">        # fallback to video_id</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> table_name </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> ""</span><span style="color:#F92672"> or</span><span style="color:#F8F8F2"> table_name </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> None</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F92672">            try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                ic(</span><span style="color:#E6DB74">"Grabbing table name from video_id"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">                video_id </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> get_video_id_from_ytube_url(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.video_url)</span></span>
<span class="line"><span style="color:#FD971F">                self</span><span style="color:#F8F8F2">.video_id </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> video_id</span></span>
<span class="line"><span style="color:#F92672">            except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> e:</span></span>
<span class="line"><span style="color:#F8F8F2">                ic(e)</span></span>
<span class="line"><span style="color:#F8F8F2">                ic(</span><span style="color:#E6DB74">"Error getting video id"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FD971F">                self</span><span style="color:#F8F8F2">.video_id </span><span style="color:#F92672">=</span><span style="color:#E6DB74"> ""</span></span>
<span class="line"><span style="color:#F92672">        else</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            ic(</span><span style="color:#66D9EF;font-style:italic">f</span><span style="color:#E6DB74">"setting table_name from TABLE_NAME as: </span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">table_name</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FD971F">            self</span><span style="color:#F8F8F2">.video_id </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> table_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.db_manager </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> DB_MANAGER()</span></span>
<span class="line"><span style="color:#F92672">        try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#66D9EF">            print</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"Creating table for named: "</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.video_id)</span></span>
<span class="line"><span style="color:#88846F">            # create table if it doesn't exist</span></span>
<span class="line"><span style="color:#FD971F">            self</span><span style="color:#F8F8F2">.db_manager.create_tables(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.video_id)</span></span>
<span class="line"><span style="color:#F92672">        except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> e:</span></span>
<span class="line"><span style="color:#66D9EF">            print</span><span style="color:#F8F8F2">(e)</span></span>
<span class="line"><span style="color:#F8F8F2">            ic(</span><span style="color:#E6DB74">"Failed to make table"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#66D9EF">            exit</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        global_iteration </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> os.getenv(</span><span style="color:#E6DB74">"ITERATION"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">"0"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">        try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            global_iteration </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> int</span><span style="color:#F8F8F2">(global_iteration)</span></span>
<span class="line"><span style="color:#F92672">        except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> e:</span></span>
<span class="line"><span style="color:#66D9EF">            print</span><span style="color:#F8F8F2">(e)</span></span>
<span class="line"><span style="color:#F8F8F2">            global_iteration </span><span style="color:#F92672">=</span><span style="color:#AE81FF"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> global_iteration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.save_to_db </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> input_args.get(</span><span style="color:#E6DB74">"save_to_db"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">True</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.transcribe_tool </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> input_args.get(</span><span style="color:#E6DB74">"transcribe_tool"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">"whisper"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F">        # add in video format here</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    def</span><span style="color:#A6E22E"> get_channel_from_name</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">self</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#F8F8F2">        metadata </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.metadata</span></span>
<span class="line"><span style="color:#F8F8F2">        channel </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> metadata.get(</span><span style="color:#E6DB74">"channel"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        uploader_id </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> metadata.get(</span><span style="color:#E6DB74">"uploader_id"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        uploader </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> metadata.get(</span><span style="color:#E6DB74">"uploader"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> uploader </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> "Yahoo Finance"</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F92672">            return</span><span style="color:#E6DB74"> "YahooFinance"</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> uploader_id </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> "Bloomberg"</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F92672">            return</span><span style="color:#E6DB74"> "Bloomberg"</span></span>
<span class="line"><span style="color:#F92672">        return</span><span style="color:#F8F8F2"> channel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    def</span><span style="color:#A6E22E"> transcribe</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">data</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">dict</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#E6DB74">            takes video file and transcribes it</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#F8F8F2">        filename </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E6DB74">"filename"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        is_livestream </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E6DB74">"is_livestream"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">False</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        ic(</span><span style="color:#66D9EF;font-style:italic">f</span><span style="color:#E6DB74">"Transcribing... </span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">filename</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F">        # read config, see if we want to upload to db</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.transcribe_tool </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> "whisper"</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> transcribe_audio_whisper(filename, is_livestream)</span></span>
<span class="line"><span style="color:#F92672">        else</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> transcribe_audio_wit(filename, is_livestream)</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> data </span><span style="color:#F92672">is</span><span style="color:#F92672"> not</span><span style="color:#AE81FF"> None</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#88846F">            # save to json file, replace .mp3 with .json</span></span>
<span class="line"><span style="color:#F8F8F2">            partial_output </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> filename.replace(</span><span style="color:#E6DB74">".mp4"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">".json"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">            # adjust all run times here based on runtime</span></span>
<span class="line"><span style="color:#F8F8F2">            curr_run_time </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> format_time(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">'run_time'</span><span style="color:#F8F8F2">])</span></span>
<span class="line"><span style="color:#F92672">            if</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">></span><span style="color:#AE81FF"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                curr_total_time </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">*</span><span style="color:#AE81FF"> MAX_ITERATIONS</span><span style="color:#F92672"> *</span><span style="color:#AE81FF"> VIDEO_CHUNK_LENGTH_IN_SECS</span><span style="color:#F92672"> +</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"run_time"</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">                curr_run_time </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> format_time(curr_total_time)</span></span>
<span class="line"><span style="color:#88846F">            # adjust times in tokens under data</span></span>
<span class="line"><span style="color:#88846F">            # </span><span style="color:#F92672">TODO</span><span style="color:#88846F"> fix this for the speech section</span></span>
<span class="line"><span style="color:#F92672">            for</span><span style="color:#F8F8F2"> token </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E6DB74">"tokens"</span><span style="color:#F8F8F2">, []):</span></span>
<span class="line"><span style="color:#F8F8F2">                token[</span><span style="color:#E6DB74">"start"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> token[</span><span style="color:#E6DB74">"start"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">+</span><span style="color:#F8F8F2"> curr_run_time</span></span>
<span class="line"><span style="color:#F8F8F2">                token[</span><span style="color:#E6DB74">"end"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> token[</span><span style="color:#E6DB74">"end"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">+</span><span style="color:#F8F8F2"> curr_run_time</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">            with</span><span style="color:#66D9EF"> open</span><span style="color:#F8F8F2">(partial_output, </span><span style="color:#E6DB74">"w"</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">encoding</span><span style="color:#F92672">=</span><span style="color:#E6DB74">"utf-8"</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">errors</span><span style="color:#F92672">=</span><span style="color:#E6DB74">"ignore"</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">as</span><span style="color:#F8F8F2"> f:</span></span>
<span class="line"><span style="color:#F8F8F2">                f.write(json.dumps(data, </span><span style="color:#FD971F;font-style:italic">indent</span><span style="color:#F92672">=</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#88846F">            # append to transcription</span></span>
<span class="line"><span style="color:#FD971F">            self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"transcriptions"</span><span style="color:#F8F8F2">].append(data)</span></span>
<span class="line"><span style="color:#88846F">            # send_discord_file(filename=partial_output, file=open(partial_output, "rb"))</span></span>
<span class="line"><span style="color:#F8F8F2">            text </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E6DB74">"text"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">            curr_iteration </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">*</span><span style="color:#AE81FF"> MAX_ITERATIONS</span><span style="color:#F92672"> +</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#FD971F">            self</span><span style="color:#F8F8F2">.db_manager.insert_into_db(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.video_id, text, </span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.video_url, curr_iteration)</span></span>
<span class="line"><span style="color:#88846F">            # make function to convert seconds to human readable time</span></span>
<span class="line"><span style="color:#F8F8F2">            data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {}</span></span>
<span class="line"><span style="color:#88846F">            # adjust runtime based on iteration if available</span></span>
<span class="line"><span style="color:#F8F8F2">            data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> f</span><span style="color:#E6DB74">"**</span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">curr_run_time</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">**</span><span style="color:#AE81FF">\n{</span><span style="color:#F8F8F2">text</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">"</span></span>
<span class="line"><span style="color:#88846F">            # split data content into chunks of 1900 characters</span></span>
<span class="line"><span style="color:#F8F8F2">            chunks </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">][i:i</span><span style="color:#F92672">+</span><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">for</span><span style="color:#F8F8F2"> i </span><span style="color:#F92672">in</span><span style="color:#66D9EF"> range</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">, </span><span style="color:#66D9EF">len</span><span style="color:#F8F8F2">(data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">]), </span><span style="color:#AE81FF">CHUNK_SIZE</span><span style="color:#F8F8F2">)]</span></span>
<span class="line"><span style="color:#F92672">            for</span><span style="color:#F8F8F2"> chunk </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> chunks:</span></span>
<span class="line"><span style="color:#F8F8F2">                data[</span><span style="color:#E6DB74">'content'</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> chunk</span></span>
<span class="line"><span style="color:#F8F8F2">                send_discord_msg(data)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    def</span><span style="color:#A6E22E"> send_metadata_embed</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">metadata</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">dict</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">other_data</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">dict</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#E6DB74">        Send metadata embed to discord</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#F8F8F2">        url </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> other_data.get(</span><span style="color:#E6DB74">"url"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        iteration </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> os.getenv(</span><span style="color:#E6DB74">"ITERATION"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">"0"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        embed </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#E6DB74">            "title"</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">f</span><span style="color:#E6DB74">"</span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">metadata.get(</span><span style="color:#E6DB74">'title'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">''</span><span style="color:#F8F8F2">)</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74"> - </span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">iteration</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">            "description"</span><span style="color:#F8F8F2">: metadata.get(</span><span style="color:#E6DB74">"description"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)[:</span><span style="color:#AE81FF">500</span><span style="color:#F8F8F2">],</span></span>
<span class="line"><span style="color:#E6DB74">            "url"</span><span style="color:#F8F8F2">: url,</span></span>
<span class="line"><span style="color:#E6DB74">            "thumbnail"</span><span style="color:#F8F8F2">: {</span><span style="color:#E6DB74">"url"</span><span style="color:#F8F8F2">: metadata.get(</span><span style="color:#E6DB74">"thumbnail"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)},</span></span>
<span class="line"><span style="color:#E6DB74">            "fields"</span><span style="color:#F8F8F2">: [</span></span>
<span class="line"><span style="color:#F8F8F2">                {</span></span>
<span class="line"><span style="color:#E6DB74">                    "name"</span><span style="color:#F8F8F2">: </span><span style="color:#E6DB74">"Livestream"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">                    "value"</span><span style="color:#F8F8F2">: other_data.get(</span><span style="color:#E6DB74">"is_livestream"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#E6DB74">                    "inline"</span><span style="color:#F8F8F2">: </span><span style="color:#AE81FF">True</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">                }</span></span>
<span class="line"><span style="color:#F8F8F2">            ],</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span><span style="color:#E6DB74">"embeds"</span><span style="color:#F8F8F2">: [embed]}</span></span>
<span class="line"><span style="color:#F8F8F2">        ic(</span><span style="color:#E6DB74">"Sending metadata embed"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        send_discord_msg(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    def</span><span style="color:#A6E22E"> parse_metadata</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">self</span><span style="color:#F8F8F2">) -> </span><span style="color:#66D9EF;font-style:italic">dict</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#E6DB74">        Parse metadata and send to discord.</span></span>
<span class="line"><span style="color:#E6DB74">        After a video is done recording, </span></span>
<span class="line"><span style="color:#E6DB74">        it will have both the livestream format and the mp4 format.</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#88846F">        # send metadata to discord</span></span>
<span class="line"><span style="color:#F8F8F2">        formats </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.metadata.get(</span><span style="color:#E6DB74">"formats"</span><span style="color:#F8F8F2">, [])</span></span>
<span class="line"><span style="color:#88846F">        # filter for ext = mp4</span></span>
<span class="line"><span style="color:#F8F8F2">        mp4_formats </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [f </span><span style="color:#F92672">for</span><span style="color:#F8F8F2"> f </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> formats </span><span style="color:#F92672">if</span><span style="color:#F8F8F2"> f.get(</span><span style="color:#E6DB74">"ext"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> "mp4"</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">        format_ids </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [</span><span style="color:#66D9EF;font-style:italic">int</span><span style="color:#F8F8F2">(f.get(</span><span style="color:#E6DB74">"format_id"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">)) </span><span style="color:#F92672">for</span><span style="color:#F8F8F2"> f </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> mp4_formats]</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> livestream_entries </span><span style="color:#F92672">:=</span><span style="color:#66D9EF;font-style:italic"> list</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">            set</span><span style="color:#F8F8F2">(format_ids).intersection(youtube_livestream_codes)</span></span>
<span class="line"><span style="color:#F8F8F2">        ):</span></span>
<span class="line"><span style="color:#88846F">            # get the first one</span></span>
<span class="line"><span style="color:#F8F8F2">            livestream_entries.sort()</span></span>
<span class="line"><span style="color:#F8F8F2">            selected_id </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> livestream_entries[</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        video_entries </span><span style="color:#F92672">=</span><span style="color:#66D9EF"> sorted</span><span style="color:#F8F8F2">(</span><span style="color:#66D9EF;font-style:italic">set</span><span style="color:#F8F8F2">(format_ids).intersection(youtube_mp4_codes))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        is_livestream </span><span style="color:#F92672">=</span><span style="color:#AE81FF"> True</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#66D9EF"> len</span><span style="color:#F8F8F2">(video_entries) </span><span style="color:#F92672">></span><span style="color:#AE81FF"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#88846F">            # use video format id over livestream id if available</span></span>
<span class="line"><span style="color:#F8F8F2">            selected_id </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> video_entries[</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">            is_livestream </span><span style="color:#F92672">=</span><span style="color:#AE81FF"> False</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F">        # </span><span style="color:#F92672">TODO</span><span style="color:#88846F"> use video format if available</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">        return</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#E6DB74">            "selected_id"</span><span style="color:#F8F8F2">: selected_id,</span></span>
<span class="line"><span style="color:#E6DB74">            "is_livestream"</span><span style="color:#F8F8F2">: is_livestream,</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span></code></pre>
<p>This is the code for a class called FD_RTT (short for “Free-Delayed Real-Time Transcription”). The class has several attributes and methods that are used to process a video and perform transcription on it.</p>
<p>The <strong>init</strong> method is the constructor for the class, which is called when an instance of the class is created. It takes two arguments, input_args and config, and uses them to initialize the class’s attributes. Some of the attributes include the video_url, stats, metadata, and transcribe_tool.</p>
<p>The get_channel_from_name method is used to determine the name of the channel that uploaded the video. It does this by checking the uploader and uploader_id fields in the metadata attribute. If either of these fields match specific values, the corresponding channel name is returned.</p>
<p>The transcribe method is used to transcribe the audio from the video. It takes a dictionary of data as an argument and uses it to determine the file to be transcribed and whether the video is a live stream. It then calls either the transcribe_audio_whisper or transcribe_audio_wit function to transcribe the audio, depending on the value of the transcribe_tool attribute. The transcription is then saved to a JSON file and appended to a list of transcriptions stored in the stats attribute.</p>
<p>The send_metadata_embed method is used to send metadata about the video to a Discord channel in the form of an embed. It takes two arguments, metadata and other_data, and uses them to create an embed object with the specified fields. It then calls the send_discord_msg function to send the embed to Discord.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#66D9EF;font-style:italic">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline">FD_RTT</span><span style="color:#F8F8F2">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AE81FF">    ...</span><span style="color:#88846F"> # code omitted for brevity</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    def</span><span style="color:#A6E22E"> process_video</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">ytube_url</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">str</span><span style="color:#F92672"> =</span><span style="color:#E6DB74"> "https://www.youtube.com/watch?v=86YLFOog4GM&#x26;ab_channel=SpaceVideos"</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#E6DB74">        Main function.</span></span>
<span class="line"><span style="color:#E6DB74">        """</span></span>
<span class="line"><span style="color:#F8F8F2">        metadata </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.metadata</span></span>
<span class="line"><span style="color:#88846F">        # grab raw data from url with mp3 versions</span></span>
<span class="line"><span style="color:#F8F8F2">        formats </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> metadata.get(</span><span style="color:#E6DB74">"formats"</span><span style="color:#F8F8F2">, [])</span></span>
<span class="line"><span style="color:#F8F8F2">        selected_id, is_livestream </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> itemgetter(</span><span style="color:#E6DB74">'selected_id'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'is_livestream'</span><span style="color:#F8F8F2">)(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.parse_metadata())</span></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.exit_on_video </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> True</span><span style="color:#F92672"> and</span><span style="color:#F8F8F2"> is_livestream </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> False</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            ic(</span><span style="color:#E6DB74">"Exiting on video as it is not a livestream"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">            append_to_github_actions(</span><span style="color:#E6DB74">"TERMINATE_LIVESTREAM=TRUE"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#66D9EF">            exit</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">        # </span><span style="color:#F92672">TODO</span><span style="color:#88846F"> fix this code so that it can handle non livestreams</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FD971F">        self</span><span style="color:#F8F8F2">.send_metadata_embed(metadata, {</span><span style="color:#E6DB74">"format_id"</span><span style="color:#F8F8F2">: selected_id, </span><span style="color:#E6DB74">"url"</span><span style="color:#F8F8F2">: ytube_url, </span><span style="color:#E6DB74">"is_livestream"</span><span style="color:#F8F8F2">: is_livestream})</span></span>
<span class="line"><span style="color:#88846F">        # to prevent link for expiring regrab when possible</span></span>
<span class="line"><span style="color:#88846F">        # loop through data and get first number</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">        while</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats.get(</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">&#x3C;</span><span style="color:#AE81FF"> MAX_ITERATIONS</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F92672">            try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#88846F">                # grab format from formats using format_id</span></span>
<span class="line"><span style="color:#F8F8F2">                selected_format </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> [f </span><span style="color:#F92672">for</span><span style="color:#F8F8F2"> f </span><span style="color:#F92672">in</span><span style="color:#F8F8F2"> formats </span><span style="color:#F92672">if</span><span style="color:#F8F8F2"> f.get(</span><span style="color:#E6DB74">"format_id"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">==</span><span style="color:#66D9EF;font-style:italic"> str</span><span style="color:#F8F8F2">(selected_id)][</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">                format_url </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> selected_format.get(</span><span style="color:#E6DB74">"url"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">                if</span><span style="color:#F92672"> not</span><span style="color:#F8F8F2"> is_livestream:</span></span>
<span class="line"><span style="color:#F8F8F2">                    filename </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> f</span><span style="color:#E6DB74">"</span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">metadata.get(</span><span style="color:#E6DB74">'id'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">''</span><span style="color:#F8F8F2">)</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">.mp4"</span></span>
<span class="line"><span style="color:#F8F8F2">                    filename </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> filename.replace(</span><span style="color:#E6DB74">"-"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">                    # get video from start</span></span>
<span class="line"><span style="color:#F92672">                    if</span><span style="color:#F92672"> not</span><span style="color:#F8F8F2"> os.path.isfile(filename):</span></span>
<span class="line"><span style="color:#F8F8F2">                           get_video_from_start(format_url, {</span></span>
<span class="line"><span style="color:#E6DB74">                                "end"</span><span style="color:#F8F8F2">: </span><span style="color:#E6DB74">"0:15:00"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">                                "filename"</span><span style="color:#F8F8F2">: filename</span></span>
<span class="line"><span style="color:#F8F8F2">                            })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F">                    # transcribe audio</span></span>
<span class="line"><span style="color:#FD971F">                    self</span><span style="color:#F8F8F2">.transcribe({</span><span style="color:#E6DB74">"filename"</span><span style="color:#F8F8F2">: filename, </span><span style="color:#E6DB74">"is_livestream"</span><span style="color:#F8F8F2">: is_livestream})</span></span>
<span class="line"><span style="color:#66D9EF">                    print</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"ARE YOU EVEN WORKING HERE"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FD971F">                    self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#AE81FF"> MAX_ITERATIONS</span></span>
<span class="line"><span style="color:#F92672">                    break</span></span>
<span class="line"><span style="color:#F8F8F2">                </span></span>
<span class="line"><span style="color:#F8F8F2">                ic(</span><span style="color:#66D9EF;font-style:italic">f</span><span style="color:#E6DB74">'Iteration: </span><span style="color:#AE81FF">{</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.stats.get(</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">)</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">                ic(format_url)</span></span>
<span class="line"><span style="color:#F8F8F2">                iterations </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats.get(</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">                filename </span><span style="color:#F92672">=</span><span style="color:#66D9EF;font-style:italic"> f</span><span style="color:#E6DB74">"</span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">metadata.get(</span><span style="color:#E6DB74">'id'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">''</span><span style="color:#F8F8F2">)</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">_</span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">iterations</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">.mp4"</span></span>
<span class="line"><span style="color:#F8F8F2">                filename </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> filename.replace(</span><span style="color:#E6DB74">"-"</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">""</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">                get_video_from_start(format_url, {</span></span>
<span class="line"><span style="color:#E6DB74">                    "end"</span><span style="color:#F8F8F2">: </span><span style="color:#E6DB74">"0:04:30"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#E6DB74">                    "filename"</span><span style="color:#F8F8F2">: filename,</span></span>
<span class="line"><span style="color:#F8F8F2">                })</span></span>
<span class="line"><span style="color:#F8F8F2">                background_thread </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> Thread(</span><span style="color:#FD971F;font-style:italic">target</span><span style="color:#F92672">=</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.transcribe, </span><span style="color:#FD971F;font-style:italic">args</span><span style="color:#F92672">=</span><span style="color:#F8F8F2">({</span><span style="color:#E6DB74">"filename"</span><span style="color:#F8F8F2">: filename, </span><span style="color:#E6DB74">"is_livestream"</span><span style="color:#F8F8F2">: is_livestream},))</span></span>
<span class="line"><span style="color:#F8F8F2">                background_thread.start()</span></span>
<span class="line"><span style="color:#F92672">            except</span><span style="color:#66D9EF;font-style:italic"> Exception</span><span style="color:#F92672"> as</span><span style="color:#F8F8F2"> ex:</span></span>
<span class="line"><span style="color:#88846F">                # any error, just goes into endless loop</span></span>
<span class="line"><span style="color:#F8F8F2">                ic(ex)</span></span>
<span class="line"><span style="color:#FD971F">                self</span><span style="color:#F8F8F2">.curr_errors </span><span style="color:#F92672">+=</span><span style="color:#AE81FF"> 1</span></span>
<span class="line"><span style="color:#F92672">                if</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.curr_errors </span><span style="color:#F92672">></span><span style="color:#AE81FF"> 10</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                    ic(</span><span style="color:#E6DB74">"Too many errors, exiting"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">                    break</span></span>
<span class="line"><span style="color:#F92672">                break</span></span>
<span class="line"><span style="color:#F92672">            finally</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FD971F">                self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">+=</span><span style="color:#AE81FF"> 1</span></span>
<span class="line"><span style="color:#F8F8F2">                start_time </span><span style="color:#F92672">=</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"start_time"</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#FD971F">                self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">"run_time"</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> (time.time() </span><span style="color:#F92672">-</span><span style="color:#F8F8F2"> start_time)</span></span>
<span class="line"><span style="color:#F8F8F2">                ic(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.stats)</span></span>
<span class="line"><span style="color:#88846F">                # every 5 iterations check if we should close</span></span>
<span class="line"><span style="color:#F92672">                if</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats.get(</span><span style="color:#E6DB74">"iterations"</span><span style="color:#F8F8F2">, </span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">%</span><span style="color:#AE81FF"> 5</span><span style="color:#F92672"> ==</span><span style="color:#AE81FF"> 0</span><span style="color:#F92672"> and</span><span style="color:#F8F8F2"> is_livestream:</span></span>
<span class="line"><span style="color:#F8F8F2">                    _, still_is_livestream </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> itemgetter(</span><span style="color:#E6DB74">'selected_id'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'is_livestream'</span><span style="color:#F8F8F2">)(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.parse_metadata())</span></span>
<span class="line"><span style="color:#F92672">                    if</span><span style="color:#F8F8F2"> still_is_livestream </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> False</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                        ic(</span><span style="color:#E6DB74">"Exiting since livestream is finished"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#66D9EF">                        print</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"LIVESTREAM IS FINISHED"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">                        # send message to discord</span></span>
<span class="line"><span style="color:#F8F8F2">                        fmtted_run_time </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> format_time(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">*</span><span style="color:#AE81FF"> MAX_ITERATIONS</span><span style="color:#F92672"> *</span><span style="color:#AE81FF"> VIDEO_CHUNK_LENGTH_IN_SECS</span><span style="color:#F92672"> +</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">'run_time'</span><span style="color:#F8F8F2">])</span></span>
<span class="line"><span style="color:#F8F8F2">                        data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span><span style="color:#E6DB74">"content"</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">f</span><span style="color:#E6DB74">"LIVESTREAM IS FINISHED </span><span style="color:#AE81FF">\n</span><span style="color:#E6DB74"> Run time: </span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">fmtted_run_time</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">"</span><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#F8F8F2">                        send_discord_msg(data)</span></span>
<span class="line"><span style="color:#F8F8F2">                        append_to_github_actions(</span><span style="color:#E6DB74">"TERMINATE_LIVESTREAM=TRUE"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#66D9EF">                        exit</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">                    else</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                        ic(</span><span style="color:#E6DB74">"Livestream is still running"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">></span><span style="color:#AE81FF"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">            fmtted_run_time </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> format_time(</span><span style="color:#FD971F">self</span><span style="color:#F8F8F2">.global_iteration </span><span style="color:#F92672">*</span><span style="color:#AE81FF"> MAX_ITERATIONS</span><span style="color:#F92672"> *</span><span style="color:#AE81FF"> VIDEO_CHUNK_LENGTH_IN_SECS</span><span style="color:#F92672"> +</span><span style="color:#FD971F"> self</span><span style="color:#F8F8F2">.stats[</span><span style="color:#E6DB74">'run_time'</span><span style="color:#F8F8F2">])</span></span>
<span class="line"><span style="color:#F8F8F2">            total_data </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#E6DB74">                "content"</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">f</span><span style="color:#E6DB74">"**Total Run Time** </span><span style="color:#AE81FF">{</span><span style="color:#F8F8F2">fmtted_run_time</span><span style="color:#AE81FF">}</span><span style="color:#E6DB74">"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">            send_discord_msg(total_data)</span></span>
<span class="line"><span style="color:#F92672">        return</span><span style="color:#AE81FF"> None</span></span></code></pre>
<p>The process_video function seems to be the main function of the FD_RTT class. It starts by fetching metadata about the video using the parse_metadata method and then sends this metadata to the send_metadata_embed method.</p>
<p>Then, it enters a loop that will run for a maximum of MAX_ITERATIONS iterations. Within the loop, it attempts to download a chunk of the video, transcribe it, and update the stats dictionary. If the video is not a live stream, the loop will only run once and the transcription will be performed on the entire video. If the video is a live stream, the loop will run continuously until the live stream ends or until MAX_ITERATIONS iterations have been reached.</p>
<p>Every 5 iterations, the process_video function checks if the live stream has ended using the parse_metadata method. If the live stream has ended, the function sends a message to Discord and exits.</p>
<p>The transcribe method is called with a dictionary containing the filename of the video chunk and a boolean indicating whether the video is a live stream or not. The transcribe method will then transcribe the audio of the video chunk using either the transcribe_audio_whisper or transcribe_audio_wit method, depending on the value of the transcribe_tool attribute.</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#66D9EF;font-style:italic">def</span><span style="color:#A6E22E"> main</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">params</span><span style="color:#F8F8F2">: </span><span style="color:#66D9EF;font-style:italic">dict</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#F8F8F2">    ic(</span><span style="color:#E6DB74">"Trying to initialize"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    fd_rtt </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> FD_RTT(params, {})</span></span>
<span class="line"><span style="color:#F8F8F2">    ic(</span><span style="color:#E6DB74">"Attempting to run video"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    fd_rtt.process_video(params.get(</span><span style="color:#E6DB74">"url"</span><span style="color:#F8F8F2">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">if</span><span style="color:#F8F8F2"> __name__ </span><span style="color:#F92672">==</span><span style="color:#E6DB74"> "__main__"</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#88846F">    # argparser with one arugment url for youtube videos</span></span>
<span class="line"><span style="color:#F8F8F2">    parser </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> argparse.ArgumentParser(</span><span style="color:#FD971F;font-style:italic">description</span><span style="color:#F92672">=</span><span style="color:#E6DB74">'Process livestream or audio for youtube video'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">    # parser.add_argument('--url', '-id', help='video id', default='https://www.youtube.com/watch?v=dp8PhLsUcFE&#x26;ab_channel=BloombergQuicktake%3AOriginals')</span></span>
<span class="line"><span style="color:#F8F8F2">    parser.add_argument(</span><span style="color:#E6DB74">'--url'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'-id'</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">help</span><span style="color:#F92672">=</span><span style="color:#E6DB74">'video id'</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">default</span><span style="color:#F92672">=</span><span style="color:#E6DB74">'https://www.youtube.com/watch?v=21X5lGlDOfg&#x26;ab_channel=NASA'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    parser.add_argument(</span><span style="color:#E6DB74">'--exit_for_videos'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'-efv'</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">help</span><span style="color:#F92672">=</span><span style="color:#E6DB74">'exit for videos, or non livestreams'</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">default</span><span style="color:#F92672">=</span><span style="color:#AE81FF">False</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#88846F">    # save_to_db</span></span>
<span class="line"><span style="color:#F8F8F2">    parser.add_argument(</span><span style="color:#E6DB74">'--save_to_db'</span><span style="color:#F8F8F2">, </span><span style="color:#E6DB74">'-stdb'</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">help</span><span style="color:#F92672">=</span><span style="color:#E6DB74">'save to db'</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">default</span><span style="color:#F92672">=</span><span style="color:#AE81FF">True</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    </span></span>
<span class="line"><span style="color:#F8F8F2">    args </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> parser.parse_args()</span></span>
<span class="line"><span style="color:#88846F">    # ensure WIT_AI_TOKEN is set</span></span>
<span class="line"><span style="color:#F8F8F2">    ic(</span><span style="color:#E6DB74">"Running main"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> os.environ.get(</span><span style="color:#E6DB74">"WIT_AI_TOKEN"</span><span style="color:#F8F8F2">) </span><span style="color:#F92672">is</span><span style="color:#AE81FF"> None</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#66D9EF">        print</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"WIT_AI_TOKEN is not set"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#66D9EF">        exit</span><span style="color:#F8F8F2">(</span><span style="color:#AE81FF">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    dict_args </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#E6DB74">        "url"</span><span style="color:#F8F8F2">: args.url,</span></span>
<span class="line"><span style="color:#E6DB74">        "exit_on_video"</span><span style="color:#F8F8F2">: args.exit_for_videos,</span></span>
<span class="line"><span style="color:#E6DB74">        "save_to_db"</span><span style="color:#F8F8F2">: args.save_to_db,</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    main(dict_args)</span></span></code></pre>
<p>This is the main function of the FD_RTT class. It appears to take an input argument “params” which is a dictionary containing a key “url” with a default value of a YouTube video URL. It creates an instance of the FD_RTT class using the input argument “params” and an empty dictionary as arguments for the class constructor. It then calls the process_video() method of the FD_RTT instance, passing in the “url” value from the “params” dictionary as an argument.</p>
<p>The main function also includes an “if” statement that checks if the environment variable “WIT_AI_TOKEN” is set. If it is not set, the script exits with a status code of 1.</p>
<p>If the script is run as a standalone script, it will use the argparse module to define command line arguments. It defines a single argument “—url” or “-id” with a default value of a YouTube video URL. It also defines an optional argument “—exit_for_videos” or “-efv” with a default value of False and an optional argument “—save_to_db” or “-stdb” with a default value of True. It then creates a dictionary “dict_args” using the values of these command line arguments and passes it to the main() function as an argument.</p>
<p>In the next article we will cover the internal workings of the transcribe_audio_whisper method and the approach I took.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/dli-invest/fdrtt">https://github.com/dli-invest/fdrtt</a></li>
<li><a href="https://github.com/dli-invest/fdrtt-stream">https://github.com/dli-invest/fdrtt-stream</a></li>
</ul> </content></div></div></div></div> <div class="mx-auto max-w-screen-lg px-3 py-6"> <div class="no-print flex w-full"> <form class="max-w-lg" action="https://formspree.io/f/davidli012345@gmail.com" method="POST"><div class="-mx-3 mb-6 flex flex-wrap"><div class="mb-6 w-full px-3 md:mb-0 md:w-1/2"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-first-name">First Name</label><input class="mb-3 block w-full appearance-none rounded py-3 px-4 leading-tight text-gray-700 focus:bg-white focus:outline-none" id="grid-first-name" type="text" placeholder="Jane"/></div><div class="w-full px-3 md:w-1/2"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-last-name">Last Name</label><input class="block w-full appearance-none rounded border border-gray-200  py-3 px-4 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none" id="grid-last-name" type="text" placeholder="Doe"/></div></div><div class="-mx-3 mb-6 flex flex-wrap"><div class="w-full px-3"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-password">E-mail</label><input class="mb-3 block w-full appearance-none rounded border py-3 px-4 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none" id="email" type="email"/></div></div><div class="-mx-3 mb-6 flex flex-wrap"><div class="w-full px-3"><label class="mb-2 block text-xs font-bold uppercase tracking-wide" for="grid-password">Message</label><textarea class="no-resize mb-3 block h-48 w-full resize-none appearance-none rounded border border-gray-200 py-3 px-4 leading-tight text-gray-700 focus:border-gray-500 focus:bg-white focus:outline-none" id="message"></textarea></div></div><div class="md:flex md:items-center"><div class="md:w-1/3"><button class="ml-2 shrink-0 rounded-full bg-gradient-to-br from-sky-500 to-cyan-400 px-3 py-1 text-sm font-medium text-gray-700 hover:from-sky-700 hover:to-cyan-600 focus:outline-none focus:ring-2 focus:ring-cyan-600/50" type="submit">Send</button></div><div class="md:w-2/3"></div></div></form> <div class="ml-3 max-w-lg bg-slate-300"> <link href="/_pagefind/pagefind-ui.css" rel="stylesheet"> <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script> <div id="search" class="ml-3 p-4"></div>  </div> </div> </div>  </div> <div class="mx-auto max-w-screen-lg px-3 py-6"><div class="no-print border-t border-gray-600 pt-5"><div class="text-sm text-gray-200">© Copyright <!-- -->2024<!-- --> by <!-- -->FriendlyUsers Tech Blog<!-- -->. Built with ♥ by<!-- --> <a class="text-cyan-400 hover:underline" href="https://github.com/FriendlyUser" target="_blank" rel="noopener noreferrer">FriendlyUser</a>. Last updated on <!-- -->2024-03-28<!-- -->.</div></div><script src="https://cdn.botpress.cloud/webchat/v0/inject.js"></script><script src="https://mediafiles.botpress.cloud/0df54034-3318-451a-aed0-3923a4ee25a5/webchat/config.js" defer=""></script></div> </body></html>